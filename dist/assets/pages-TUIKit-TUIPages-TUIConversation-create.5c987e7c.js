import{aJ as e,o as s,e as t,w as o,aK as r,aM as n,i as a,f as i,k as l,l as u,F as c,j as p,ac as f,ad as I,d,N as h,Q as m,u as C,v as U}from"./index-c87fa551.js";import{s as v}from"./index.befce884.js";import{b as D}from"./uni-app.es.d136296e.js";import{_ as P}from"./selected.51ceb6f0.js";import{_}from"./_plugin-vue_export-helper.1b428a4d.js";const g=_(e({name:"Create",props:{},setup(e,s){const t=uni.$TUIKit.TUIConversationServer,{userInfo:o}=v.state.timStore,a=r({userID:(null==o?void 0:o.userID)||"",inputUserID:"",chooseUserList:[],title:"发起会话",myProfile:{},type:uni.$TIM.TYPES.CONV_C2C});D((e=>{a.title=e&&e.title||"发起会话",a.type=e&&e.type||uni.$TIM.TYPES.CONV_C2C}));const i=e=>{v.commit("timStore/setConversationID",e),t.setMessageRead(e),t.getConversationProfile(e).then((s=>{var t;const{conversation:o}=s.data;console.log("create conversation response = ",s),v.commit("timStore/setConversation",o);let r="../TUIChat/index";if("GROUP"===e.slice(0,5)){const{name:e}=o.groupProfile;r=`${r}?conversationName=${e}`}else"C2C"===e.slice(0,3)&&(o.userProfile,r=`${r}?conversationName=${(null==(t=o.userProfile.nick)?void 0:t.nick)||o.userProfile.userID}`);h({url:r})})).catch((e=>{console.warn("获取 group profile 异常 = ",e)}))};return{...n(a),handleUserIdInput:e=>{a.inputUserID=e.detail.value,uni.$TUIKit.getMyProfile().then((e=>{a.myProfile=e.data})).catch((e=>{console.warn("getMyProfile error:",e)}))},handleGetUserProfileInfo:()=>{if(!a.inputUserID)return;const e=[a.inputUserID];f({title:"加载中"}),uni.$TUIKit.getUserProfile({userIDList:e}).then((e=>{if(I(),e.data.length>0){const s={...e.data[0],isChoose:!1};0===a.chooseUserList.filter((e=>s.userID===e.userID)).length&&a.chooseUserList.push(s)}else d({title:"搜索用户不存在",icon:"error"}),a.inputUserID=""})).catch((e=>{I()}))},handleChoose:e=>{const s=a.chooseUserList.map((s=>e.userID==s.userID?{...s,isChoose:!s.isChoose}:s));a.chooseUserList=s},handleCreateGroup:()=>{var e,s;const t=a.chooseUserList.filter((e=>e.isChoose));if(t.length>0)switch(a.type){case uni.$TIM.TYPES.CONV_C2C:if(t.length>1)return void d({title:"“发起会话”仅能选择一个用户",icon:"none"});{const e=`C2C${t[0].userID}`;i(e)}break;case uni.$TIM.TYPES.GRP_WORK:case uni.$TIM.TYPES.GRP_PUBLIC:case uni.$TIM.TYPES.GRP_MEETING:{let o="";o=t.length>2?t.slice(0,3).map((e=>e.nick||e.userID)).join(",")||"":t.map((e=>e.nick||e.userID)).join(",")+"、"+((null==(e=a.myProfile)?void 0:e.nick)||(null==(s=a.myProfile)?void 0:s.userID));const r={avatar:"https://web.sdk.qcloud.com/component/TUIKit/assets/group_avatar.png",type:a.type,name:o,memberList:t.map((e=>({userID:e.userID,role:e.role,memberCustomField:e.memberCustomField})))};f({title:"群组创建中…"}),uni.$TUIKit.createGroup(r).then((e=>{I();const{groupID:s}=e.data&&e.data.group;if(s){i(`GROUP${s}`)}})).catch((e=>{console.log(o),d({title:"群组创建失败！"}),I()}));break}}else d({title:"请选择相关用户",icon:"none"})}}}}),[["render",function(e,r,n,f,I,d){const h=m,v=a,D=U;return s(),t(v,{class:"TUI-Create-conversation-container"},{default:o((()=>[i(v,{class:"tui-search-area"},{default:o((()=>[i(v,{class:"tui-search-bar"},{default:o((()=>[i(h,{class:"tui-search-bar-input",value:e.inputUserID,placeholder:"请输入用户ID",onInput:e.handleUserIdInput,onConfirm:e.handleGetUserProfileInfo,onBlur:e.handleGetUserProfileInfo},null,8,["value","onInput","onConfirm","onBlur"])])),_:1}),i(v,{class:"tui-showID"})])),_:1}),i(v,{class:"tui-person-list-container"},{default:o((()=>[(s(!0),l(c,null,u(e.chooseUserList,((r,n)=>(s(),t(v,{class:"tui-person-to-invite",key:n,onClick:s=>e.handleChoose(r)},{default:o((()=>[i(v,{class:"tui-person-choose-container"},{default:o((()=>[r.isChoose?(s(),t(D,{key:0,class:"tui-normal-choose",src:P})):(s(),t(v,{key:1,class:"tui-normal-unchoose"}))])),_:2},1024),i(v,{class:"tui-person-profile"},{default:o((()=>[i(D,{class:"tui-person-profile-avatar",src:r.avatar||"https://sdk-web-1252463788.cos.ap-hongkong.myqcloud.com/component/TUIKit/assets/avatar_21.png"},null,8,["src"]),i(v,null,{default:o((()=>[i(v,{class:"tui-person-profile-nick"},{default:o((()=>[p(C(r.nick),1)])),_:2},1024),i(v,{class:"tui-person-profile-userID"},{default:o((()=>[p("用户ID："+C(r.userID),1)])),_:2},1024)])),_:2},1024)])),_:2},1024)])),_:2},1032,["onClick"])))),128))])),_:1}),i(v,{class:"tui-confirm-btn-container"},{default:o((()=>[i(v,{class:"tui-confirm-btn",onClick:e.handleCreateGroup},{default:o((()=>[p("确认创建")])),_:1},8,["onClick"])])),_:1})])),_:1})}],["__scopeId","data-v-b7c6481e"]]);export{g as default};
