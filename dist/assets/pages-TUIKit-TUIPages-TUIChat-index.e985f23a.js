import{aJ as e,aK as s,aL as a,aM as t,o,e as n,w as i,f as l,j as r,u as d,q as c,t as u,A as g,a6 as m,k as h,v as p,aN as I,i as f,F as T,l as y,a2 as M,m as v,d as S,n as x,aP as C,aQ as D,aR as k,aH as U,aS as E,O as w,P as _,ad as b,D as L,a8 as P,am as A,a9 as R,x as j,Q as N,aT as G,aU as O,aV as V,aa as $,C as F,M as Y,aG as B,S as Z}from"./index-c87fa551.js";import{b as z,o as J,d as K,a as W}from"./uni-app.es.d136296e.js";import{_ as Q}from"./_plugin-vue_export-helper.1b428a4d.js";import{f as X,c as H}from"./date.8f6fd309.js";import{a as q,e as ee,b as se,c as ae,f as te}from"./emojiMap.0d0f2d67.js";import{s as oe}from"./index.befce884.js";import{I as ne}from"./IComponentServer.e3f3b233.js";import{_ as ie}from"./newback.d745f51c.js";class le extends ne{constructor(e){super(),this.currentStore={},this.store=oe.state.timStore,this.TUICore=uni.$TUIKit,this.bindTIMEvent(),this.updateStore()}destroyed(){this.unbindTIMEvent()}updateStore(){this.getMessageList({conversationID:this.store.conversationID,count:15}),oe.commit("timStore/resetChat")}bindTIMEvent(){this.TUICore.on(uni.$TIM.EVENT.MESSAGE_RECEIVED,this.handleMessageReceived,this),this.TUICore.on(uni.$TIM.EVENT.MESSAGE_MODIFIED,this.handleMessageModified,this),this.TUICore.on(uni.$TIM.EVENT.MESSAGE_REVOKED,this.handleMessageRevoked,this),this.TUICore.on(uni.$TIM.EVENT.MESSAGE_READ_BY_PEER,this.handleMessageReadByPeer,this),this.TUICore.on(uni.$TIM.EVENT.GROUP_LIST_UPDATED,this.handleGroupListUpdated,this)}unbindTIMEvent(){this.TUICore.off(uni.$TIM.EVENT.MESSAGE_RECEIVED,this.handleMessageReceived),this.TUICore.off(uni.$TIM.EVENT.MESSAGE_MODIFIED,this.handleMessageModified),this.TUICore.off(uni.$TIM.EVENT.MESSAGE_REVOKED,this.handleMessageRevoked),this.TUICore.off(uni.$TIM.EVENT.MESSAGE_READ_BY_PEER,this.handleMessageReadByPeer),this.TUICore.off(uni.$TIM.EVENT.GROUP_LIST_UPDATED,this.handleGroupListUpdated,this)}handleMessageReceived(e){console.log(e,"handleMessageReceived"),e.data.forEach((e=>{if(e.conversationID===this.store.conversationID){uni.$TUIKit.TUIConversationServer.setMessageRead(e.conversationID);const s=[...this.store.messageList,e];oe.commit("timStore/setMessageList",s)}}))}handleMessageModified(e){const s=this.store.messageList;this.store.messageList=[],this.store.messageList=s}handleMessageRevoked(e){}async handleMessageReadByPeer(e){const s=this.store.messageList;await oe.commit("timStore/resetChat"),await oe.commit("timStore/setMessageList",s)}handleGroupListUpdated(e){null==e||e.data.map((e=>{var s,a,t;if((null==e?void 0:e.groupID)===(null==(t=null==(a=null==(s=null==this?void 0:this.store)?void 0:s.conversation)?void 0:a.groupProfile)?void 0:t.groupID)){this.store.conversation.groupProfile=e;const s=this.store.conversation;this.store.conversation={},this.store.conversation=s}return e}))}handleMessageOptions(e,s,a,t){var o,n,i,l,r,d;const c={to:"",conversationType:(null==t?void 0:t.type)||this.store.conversation.type,payload:e,needReadReceipt:!0};switch("file"===s&&a&&(c.onProgress=a),c.conversationType){case uni.$TIM.TYPES.CONV_C2C:c.to=(null==(o=null==t?void 0:t.userProfile)?void 0:o.userID)||(null==(i=null==(n=this.store.conversation)?void 0:n.userProfile)?void 0:i.userID)||"";break;case uni.$TIM.TYPES.CONV_GROUP:c.to=(null==(l=null==t?void 0:t.groupProfile)?void 0:l.groupID)||(null==(d=null==(r=this.store.conversation)?void 0:r.groupProfile)?void 0:d.groupID)||""}return c}handlePromiseCallback(e){return new Promise(((e,s)=>{}))}handleUploadProgress(e,s){this.store.messageList.map((a=>(a.ID===s.ID&&(a.progress=e),a)))}sendTextMessage(e){return new Promise((async(s,a)=>{try{const a=this.handleMessageOptions({text:e},"text"),t=this.TUICore.createTextMessage(a),o=[...this.store.messageList,t];oe.commit("timStore/setMessageList",o);const n=await this.TUICore.sendMessage(t);this.store.messageList=this.store.messageList.map((e=>e.ID===n.data.message.ID?n.data.message:e)),s(n)}catch(t){a(t);const e=this.store.messageList;oe.commit("timStore/resetChat"),oe.commit("timStore/setMessageList",e)}}))}sendFaceMessage(e){return new Promise((async(s,a)=>{try{const a=this.handleMessageOptions(e,"face"),t=this.TUICore.createFaceMessage(a),o=[...this.store.messageList,t];oe.commit("timStore/setMessageList",o);const n=await this.TUICore.sendMessage(t);this.store.messageList=this.store.messageList.map((e=>e.ID===n.data.message.ID?n.data.message:e)),s(n)}catch(t){a(t)}}))}sendImageMessage(e,s){return new Promise((async(a,t)=>{try{const t=this.handleMessageOptions({file:e},"file"),o=this.TUICore.createImageMessage(t);o.payload.imageInfoArray[1].height=s.height,o.payload.imageInfoArray[1].width=s.width;const n=[...this.store.messageList,o];oe.commit("timStore/setMessageList",n);const i=await this.TUICore.sendMessage(o);this.store.messageList=this.store.messageList.map((e=>e.ID===i.data.message.ID?i.data.message:e)),a(i)}catch(o){t(o)}}))}sendVideoMessage(e,s){return new Promise((async(s,a)=>{try{const a=this.handleMessageOptions({file:e},"file"),t=this.TUICore.createVideoMessage(a),o=[...this.store.messageList,t];oe.commit("timStore/setMessageList",o);const n=await this.TUICore.sendMessage(t);this.store.messageList=this.store.messageList.map((e=>e.ID===n.data.message.ID?n.data.message:e)),s(n)}catch(t){a(t)}}))}sendAudioMessage(e){return new Promise((async(s,a)=>{try{const a=this.handleMessageOptions({file:e},"file",(e=>{this.handleUploadProgress(e,t)})),t=this.TUICore.createAudioMessage(a),o=[...this.store.messageList,t];oe.commit("timStore/setMessageList",o);const n=await this.TUICore.sendMessage(t);console.log("发送音频消息完成",n),this.store.messageList=this.store.messageList.map((e=>e.ID===n.data.message.ID?n.data.message:e)),s(n)}catch(t){a(t)}}))}sendFileMessage(e){return this.handlePromiseCallback((async(s,a)=>{try{const a=this.handleMessageOptions({file:e},"file",(e=>{this.handleUploadProgress(e,t)})),t=this.TUICore.createFileMessage(a);this.currentStore.messageList.push(t);const o=await this.TUICore.sendMessage(t);console.log("发送文件消息完成",o),this.store.messageList=this.store.messageList.map((e=>e.ID===o.data.message.ID?o.data.message:e)),s(o)}catch(t){a(t)}}))}sendCustomMessage(e){return this.handlePromiseCallback((async(s,a)=>{try{const a=this.handleMessageOptions(e,"custom"),t=this.TUICore.createCustomMessage(a);this.currentStore.messageList.push(t);const o=await this.TUICore.sendMessage(t);console.log("发送自定义消息完成",o),this.store.messageList=this.store.messageList.map((e=>e.ID===o.data.message.ID?o.data.message:e)),s(o)}catch(t){a(t)}}))}sendLocationMessage(e){return this.handlePromiseCallback((async(s,a)=>{try{const a=this.handleMessageOptions(e,"location"),t=this.TUICore.createLocationMessage(a);this.store.messageList.push(t);const o=await this.TUICore.sendMessage(t);console.log("发送地理位置消息完成",o),s(o)}catch(t){a(t)}}))}forwardMessage(e,s){return this.handlePromiseCallback((async(a,t)=>{try{const t=this.handleMessageOptions(e,"forward",{},s),o=this.TUICore.createForwardMessage(t),n=await this.TUICore.sendMessage(o);this.store.conversation.conversationID===n.data.message.conversationID&&this.store.messageList.push(n.data.message),console.log("消息转发完成",n),a(n)}catch(o){t(o)}}))}sendTextAtMessage(e){return new Promise((async(s,a)=>{try{const a=this.handleMessageOptions(e,"text"),t=this.TUICore.createTextAtMessage(a);this.currentStore.messageList.push(t);const o=await this.TUICore.sendMessage(t);this.currentStore.messageList=this.currentStore.messageList.map((e=>e.ID===o.data.message.ID?o.data.message:e)),s(o)}catch(t){a(t)}}))}sendMergerMessage(e){return this.handlePromiseCallback((async(s,a)=>{try{const a=this.handleMessageOptions(e,"merger"),t=this.TUICore.createMergerMessage(a);this.currentStore.messageList.push(t);const o=await this.TUICore.sendMessage(t);console.log("发送合并消息完成",o),this.currentStore.messageList=this.currentStore.messageList.map((e=>e.ID===o.data.message.ID?o.data.message:e)),s(o)}catch(t){a(t)}}))}async getMessageList(e,s){return new Promise((async(a,t)=>{try{const t=await this.TUICore.getMessageList(e);let o;o=s?[...t.data.messageList,...this.store.messageList]:t.data.messageList,this.currentStore.nextReqMessageID=t.data.nextReqMessageID,this.currentStore.isCompleted=t.data.isCompleted,oe.commit("timStore/setMessageList",o),a(t.data)}catch(o){t(o)}}))}async getHistoryMessageList(){return new Promise((async(e,s)=>{try{const s={conversationID:this.store.conversation.conversationID,nextReqMessageID:this.currentStore.nextReqMessageID,count:15};let a=[];this.currentStore.isCompleted||(a=await this.getMessageList(s,!0)),e(a)}catch(a){s(a)}}))}revokeMessage(e){return new Promise((async(s,a)=>{try{s(await this.TUICore.revokeMessage(e))}catch(t){a(t)}}))}resendMessage(e){return new Promise((async(s,a)=>{try{const a=await this.TUICore.resendMessage(e);console.log("消息重发完成",a);let t=[];t=this.store.messageList.filter((s=>s.ID!==e.ID)),oe.commit("timStore/setMessageList",t),s(a)}catch(t){a(t)}}))}deleteMessage(e){return new Promise((async(s,a)=>{try{const a=await this.TUICore.deleteMessage(e);let t=[];t=this.store.messageList.filter((s=>s.ID!==e.ID)),oe.commit("timStore/setMessageList",t),s(a)}catch(t){a(t)}}))}}const re=Q(e({props:{data:{type:Object,default:()=>({})}},setup(e,o){const n=s({message:{},show:!1});a((()=>{n.message=e.data}));return{...t(n),toggleDialog:()=>{n.show=!n.show}}}}),[["render",function(e,s,a,t,T,y){const M=p,v=I,S=f;return o(),n(S,{class:g(["message-bubble",["in"===e.message.flow?"":"reverse"]])},{default:i((()=>{var s;return[l(M,{class:"avatar",src:(null==(s=e.message)?void 0:s.avatar)||"https://web.sdk.qcloud.com/component/TUIKit/assets/avatar_21.png",alt:""},null,8,["src"]),l(S,{class:"message-area"},{default:i((()=>["in"===e.message.flow?(o(),n(v,{key:0,class:"name"},{default:i((()=>[r(d(e.message.nick),1)])),_:1})):c("",!0),u("div",{class:g(["content content-"+e.message.flow])},[m(e.$slots,"default",{},void 0,!0)],2)])),_:3}),"fail"===e.message.status?(o(),n(S,{key:0,class:"message-label fail"},{default:i((()=>[r("!")])),_:1})):c("",!0),"C2C"===e.message.conversationType&&"out"==e.message.flow&&"fail"!==e.message.status?(o(),n(S,{key:1,class:g(["message-label",[!e.message.isPeerRead&&"unRead"]])},{default:i((()=>[e.message.isPeerRead?(o(),h("span",{key:1},"已读")):(o(),h("span",{key:0},"未读"))])),_:1},8,["class"])):c("",!0)]})),_:3},8,["class"])}],["__scopeId","data-v-425401b1"]]);const de=Q(e({props:{data:{type:Object,default:()=>({})},messageData:{type:Object,default:()=>({})}},setup(e,o){const n=s({data:{},message:{}});return a((()=>{n.data=e.data,n.message=e.messageData})),{...t(n)}}}),[["render",function(e,s,a,t,l,u){const m=f;return o(),n(m,{class:g(["content content-"+e.message.flow])},{default:i((()=>[(o(!0),h(T,null,y(e.data.text,((e,s)=>(o(),n(m,{key:s},{default:i((()=>["text"===e.name?(o(),n(m,{key:0},{default:i((()=>[r(d(e.text),1)])),_:2},1024)):"img"===e.name?(o(),h("img",{key:1,class:"text-img",src:e.src},null,8,["src"])):c("",!0)])),_:2},1024)))),128))])),_:1},8,["class"])}],["__scopeId","data-v-e79758d3"]]);const ce=Q(e({props:{data:{type:Array,default:()=>[]},messageData:{type:Object,default:()=>({})}},setup(e,o){const n=s({imageInfo:[],imageHeight:0,imageWidth:0,message:{}});a((()=>{const s=155;let a=0,t=0;n.message=e.messageData,n.imageInfo=e.data.info[1],n.imageInfo.width>=n.imageInfo.height?(a=s,t=s*n.imageInfo.height/n.imageInfo.width):(a=s*n.imageInfo.width/n.imageInfo.height,t=s),n.imageWidth=a+"px",n.imageHeight=t+"px"}));return{...t(n),handlePreviewImage:()=>{console.error(e.data.info[0].url,"----linda"),M({current:e.data.info[0].url,urls:[e.data.info[0].url]})}}}}),[["render",function(e,s,a,t,r,d){const c=p,u=f;return o(),n(u,{class:"message-image",onClick:e.handlePreviewImage},{default:i((()=>[l(c,{src:e.data.info[1].url,style:v({height:e.imageHeight,width:e.imageWidth}),class:g(["content-"+e.message.flow])},null,8,["src","style","class"])])),_:1},8,["onClick"])}],["__scopeId","data-v-bd292fdf"]]),ue=e({props:{data:{type:Object,default:()=>({})}},setup(e,o){const n=uni.$TUIKit.TUIChatServer,i=s({message:{}});a((()=>{i.message=e.data}));return{...t(i),handleMseeage:async e=>{switch(e){case"revoke":await n.revokeMessage(i.message).catch((e=>{(e.code=20016)&&S({title:"消息超过了 2 分钟",icon:"error"})})),i.dialogID="";break;case"delete":await n.deleteMessage([i.message]),i.dialogID="";break;case"resend":await n.resendMessage(i.message),i.dialogID=""}}}}});const ge=Q(ue,[["render",function(e,s,a,t,d,u){const g=p,m=f;return o(),n(m,{class:"dialog-container"},{default:i((()=>["out"===e.message.flow&&"success"===e.message.status?(o(),n(m,{key:0,class:"item-box",onClick:s[0]||(s[0]=s=>e.handleMseeage("revoke"))},{default:i((()=>[l(g,{class:"item-icon",src:"/assets/revoked-b2d9f9de.svg"}),l(m,null,{default:i((()=>[r("撤回")])),_:1})])),_:1})):c("",!0),"success"===e.message.status?(o(),n(m,{key:1,class:"item-box",onClick:s[1]||(s[1]=s=>e.handleMseeage("delete"))},{default:i((()=>[l(g,{class:"item-icon",src:"/assets/delete-d71d694a.svg"}),l(m,null,{default:i((()=>[r("删除")])),_:1})])),_:1})):c("",!0),"out"===e.message.flow&&"fail"===e.message.status?(o(),n(m,{key:2,class:"item-box",onClick:s[2]||(s[2]=s=>e.handleMseeage("resend"))},{default:i((()=>[l(g,{class:"item-icon",src:"/assets/forword-3d253182.svg"}),l(m,null,{default:i((()=>[r("重发")])),_:1})])),_:1})):c("",!0)])),_:1})}],["__scopeId","data-v-15bbd56c"]]),me=e({props:{data:{type:Object,default:()=>({})},messageData:{type:Object,default:()=>({})}},setup(e,o){const n=s({video:{},message:{},show:!1,videoContext:null});a((()=>{n.video=e.data,n.message=e.messageData}));return{...t(n),toggleShow:()=>{x({url:`./components/message-elements/video-play?videoMessage=${n.video.url}`})}}}});const he=Q(me,[["render",function(e,s,a,t,n,i){const r=p;return o(),h("div",{class:"message-video"},[u("div",{class:g(["message-video-box",[!e.video.progress&&"message-video-cover"]]),onClick:s[0]||(s[0]=(...s)=>e.toggleShow&&e.toggleShow(...s))},[l(r,{src:e.video.snapshotUrl,class:g(["message-video-box",["content-"+e.message.flow]])},null,8,["src","class"]),l(r,{src:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEYAAABGCAYAAABxLuKEAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyRpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNi1jMDY3IDc5LjE1Nzc0NywgMjAxNS8wMy8zMC0yMzo0MDo0MiAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6NUY5QURCQ0E0RkI2MTFFNTk3QThDMzJBNTE2MDVFNEQiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6NUY5QURCQzk0RkI2MTFFNTk3QThDMzJBNTE2MDVFNEQiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNiAoTWFjaW50b3NoKSI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkYzNEJFNkIxQTc0QjExRTM4NDk4RDBGMTA0RjRBQzUxIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOkYzNEJFNkIyQTc0QjExRTM4NDk4RDBGMTA0RjRBQzUxIi8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+QQDPWgAABYNJREFUeNrknF9MW1Ucx09LBenkXyPsYSvZRib2weI6dNLNuSbGxZg+EsAlYHgxGBU0vvDmg4GgxmDUBx8IGpMRnkwQTcBEsrkKzD+VGdcRw2YdaERTnJNSSdf6/a3nLk0t/UN7zz339pt8sizd7r399vz5nnPPOSYmTiZwADSD/aAR7AM1oBJY+b8Lgy1wA6yBX8AqWAY/g7ioh1VTVeAEaAUuUFvg9f4CfvA18IG/9WQMXfNh4AXHgEWlZ4+CRfAJuFjsklRMY8rA4+AMsDOxug7Ogs/BLZmMoarSz9sOLUVt0dvgG62NqQfPgVNMLp0D74E/Cin+u9VJ8Dq4j8kn6v2eBL+CoChj7gLPgz5QzuRVOS/JFAe+AzE1jaGbjIDHmH7k4FGBuvd/1TCG2pNRcJjpTw3gOLjAA2TRjKnnrf0+pl/V8LB5PhdzcjGm1gCmJCfxNjAHIoUYQ6n1TdDEjKNq0AJmMjXI2Yyh3udRZjzVc4MWd2PMSd4lG1X3g2s75Zydku+94AOwhxlbm6AXrKd+YM5QhYxuCuPf8eV0H6Qz5iGdBbhCdYxnnIzGUNV6gZWenk31ItUYj5pzKfF4/NTU1JSjrq6uTDJj7Py7pzWGSssZtZ/A6/XuXVpaavV4PFWSmfN0cmeUbAxNRx4S8vPY7ZWzs7NHhoaG7CaTSRZjDnEP/mfMaZFPYbFYzIODg00+n8/Z2Ngoy/TF6VRj9qRrmUWora3N5vf7W9vb220SGHNciSnmpJSr2a9ms9nKJycnnWNjY00VFRVa1q1y7sUdY9xa/1TU1vT29tpRelxOp7NSw0dxK8YQD8rSAjocjqr5+fmj/f39ezV6hCPkCZlyENwjU79ptVoto6OjDo0yD7UxB8mYZlnjqIaZp9ksKrsUmHlcgjPP7RIj/ZQlMo9JcObZT8Y06GWkp2Sejo4OtTNPAxlTy3QkyjwTExNqZ54aMuZuvc0RCMg8lWSMVa+TKDzztKqQeaxmZgwVvUrRe6OwXktNIBC42dXVdRlZZ6vIlw5TiYnozZB4PM7Gx8evu1wuvwqmkLaoxNCCP5teTNnY2Nju6+u7gtF4SMXb3CBj1mVPv4oWFhZCnZ2dV4LB4LbKt1qnqrQmuyHRaDQ+MjKy4na7LwkwhbRKJeaqzKasrq5udXd3X56bm7sp8LbXyJhlWU2Znp7+vaen56dQKBQVfOtlqkr0YntTJkPC4fCtgYGBgNfrDWhgyqZSYmiNCC1DP2HwbJKryIuYkny/KoFskqtue6EYQ+vStrV6EsomKCWXMDBciUQiMQ1N2eZe3NkAQfWKlnt6DJxNcpFPaW+TB5EzorPJ8PCwyGySi2aSB5GKLvJMo3oK1iibZNNV7gFLLTG03+esiGzS0tLyrWSmMP7d4zvNY9DfP2Ti9xtpLdrv9AxLWt6aOlFFjr3LSk/vs5Q1v+lm8KienSshUxZ5b8SyGUOiTVDhEjCFvuNb6T4oy/Af/mTGXBWerDfAD/kYQ1phiZdxhw1qymfgo50+zLaSgPY300bQeoOZEgCvsgI2WcR4w0Qj72qDmEI7bV/J1obmsvaE3iJc4OZU6dyU38BLIOtEeq6LcsjdL8EjLLFTTK8hjvYN5LTlOJ/VSjTq/AI8wHS0QoLrR159cn7lku8yLtqFSscE0NI0h05M+Ri8lm8u2836thhPi0HeY8m695pK+DCYZHnuuU43iMxXVKXoCAPZtvGc5+l9fbcXKNYqAdrj9CKT49CLd1jSvIrWxijV8gnQxbQ5JmUCzDLJjklJvSZ1608xMQfrfAoWmMQH66RTNR+IHmWJFdfFOIrpe5Y4H4Zyla6OYsp0rwMsseDazlEO76Luv4KXAnqn9A//c41XE0Lo4V3/CTAAFPSPXCEbSD0AAAAASUVORK5CYII=",class:"video-play"})],2)])}],["__scopeId","data-v-9280aa43"]]),pe=C(),Ie=e({props:{data:{type:Object,default:()=>({})},messageData:{type:Object,default:()=>({})}},setup(e,o){const n=s({data:{},message:{},isPlay:!1});a((()=>{n.data=e.data,n.message=e.messageData})),D((()=>{pe.onPlay((()=>{console.log("开始播放")})),pe.onEnded((()=>{console.log("停止播放")})),pe.onError((e=>{console.error(e,"onError"),S({icon:"none",title:"该音频暂不支持播放"})}))}));return{...t(n),audio:pe,handlePlay:()=>{n.data.url&&(pe.src=n.data.url,pe.play()),n.isPlay=!0}}}}),fe="/assets/audio-play-cfecc582.svg";const Te=Q(Ie,[["render",function(e,s,a,t,u,m){const h=p,I=f;return o(),n(I,{class:g(["message-audio",["content content-"+e.message.flow]]),onClick:e.handlePlay},{default:i((()=>["in"===e.message.flow?(o(),n(h,{key:0,class:"audio-icon audio-icon-in",src:fe})):c("",!0),l(I,null,{default:i((()=>[r(d(e.data.second)+"s",1)])),_:1}),"out"===e.message.flow?(o(),n(h,{key:1,class:"audio-icon",src:fe})):c("",!0)])),_:1},8,["class","onClick"])}],["__scopeId","data-v-eb3416ba"]]);const ye=Q(e({props:{data:{type:Object,default:()=>({})}},setup(e,o){const n=s({data:{}});return a((()=>{n.data=e.data})),{...t(n)}}}),[["render",function(e,s,a,t,i,l){const r=p;return o(),n(r,{class:"message-image",src:e.data.url},null,8,["src"])}],["__scopeId","data-v-0494c1af"]]);const Me=Q(e({props:{data:{type:Object,default:()=>({})},messageData:{type:Object,default:()=>({})}},setup(e,o){const n=s({data:{},extension:{},isCustom:"",payload:{},message:{}});return a((()=>{n.data=e.data,n.message=e.messageData,n.isCustom=e.data.message.payload.data,n.payload=e.data.message.payload,"consultion"===e.data.message.payload.data&&(n.extension=JSON.parse(e.data.message.payload.extension))})),{...t(n)}}}),[["render",function(e,s,a,t,l,r){const c=f;return o(),n(c,{class:"custom"},{default:i((()=>["consultion"===e.isCustom?(o(),h("div",{key:0},[u("h1",null,d(e.extension.title),1),u("ul",null,[(o(!0),h(T,null,y(e.extension.item,((e,s)=>(o(),h("li",{key:s},[u("a",{href:e.value},d(e.key),9,["href"])])))),128))]),u("article",null,d(e.extension.description),1)])):"evaluate"===e.isCustom?(o(),h("div",{key:1,class:"evaluate"},[u("h1",null,"对本次服务评价"),u("ul",null,[(o(!0),h(T,null,y(~~e.payload.description,((e,s)=>(o(),h("li",{class:"evaluate-list-item",key:s},[u("i",{class:"icon icon-star-light"})])))),128))]),u("article",null,d(e.data.custom),1)])):(o(),h("span",{key:2,class:g(["content content-"+e.message.flow])},d(e.data.custom),3))])),_:1})}],["__scopeId","data-v-20845983"]]);const ve=Q(e({props:{data:{type:Object,default:()=>({})}},setup(e,o){const n=s({message:{}});return a((()=>{n.message=e.data})),{...t(n)}}}),[["render",function(e,s,a,t,n,i){return o(),h("div",{class:"message-tip"},d(e.message.text),1)}],["__scopeId","data-v-c3410b95"]]);const Se=Q(e({props:{data:{type:Object,default:()=>({})}},setup(e,o){const n=s({message:{}});a((()=>{n.message=e.data}));return{...t(n),edit:()=>{o.emit("edit",n.message)}}}}),[["render",function(e,s,a,t,l,g){const m=I;return o(),h("div",{class:"revoke"},["in"===e.message.flow?(o(),n(m,{key:0},{default:i((()=>[r(d(e.message.nick||e.message.from),1)])),_:1})):(o(),n(m,{key:1},{default:i((()=>[r("你")])),_:1})),u("span",null,"撤回了一条消息"),"out"===e.message.flow?(o(),h("span",{key:2,class:"edit",onClick:s[0]||(s[0]=(...s)=>e.edit&&e.edit(...s))},"重新编辑")):c("",!0)])}],["__scopeId","data-v-3301315b"]]);function xe(e){const s=[];let a=e.text,t=-1,o=-1;for(;""!==a;)switch(t=a.indexOf("["),o=a.indexOf("]"),t){case 0:if(-1===o)s.push({name:"text",text:a}),a="";else{const e=a.slice(0,o+1);q[e]?(s.push({name:"img",src:ee+q[e]}),a=a.substring(o+1)):(s.push({name:"text",text:"["}),a=a.slice(1))}break;case-1:s.push({name:"text",text:a}),a="";break;default:s.push({name:"text",text:a.slice(0,t)}),a=a.substring(t)}return s}function Ce(e){const s={message:e,text:""},a=e.nick||e.payload.userIDList.join(",");switch(e.payload.operationType){case uni.$TIM.TYPES.GRP_TIP_MBR_JOIN:s.text=`群成员：${a} 加入群组`;break;case uni.$TIM.TYPES.GRP_TIP_MBR_QUIT:s.text=`群成员：${a} 退出群组`;break;case uni.$TIM.TYPES.GRP_TIP_MBR_KICKED_OUT:s.text=`群成员：${a} 被 ${e.payload.operatorID} 踢出群组`;break;case uni.$TIM.TYPES.GRP_TIP_MBR_SET_ADMIN:s.text=`群成员：${a} 成为管理员`;break;case uni.$TIM.TYPES.GRP_TIP_MBR_CANCELED_ADMIN:s.text=`群成员：${a} 被撤销管理员`;break;case uni.$TIM.TYPES.GRP_TIP_GRP_PROFILE_UPDATED:s.text=function(e){const{payload:s}=e,{newGroupProfile:a}=s,{operatorID:t}=s;let o="";const n=Object.keys(a)[0];switch(n){case"ownerID":o=`${a[n]} 成为新的群主`;break;case"groupName":o=`${t} 修改群名为 ${a[n]}`;break;case"notification":o=`${t} 发布新公告`}return o}(e);break;case uni.$TIM.TYPES.GRP_TIP_MBR_PROFILE_UPDATED:for(const a of e.payload.memberList)a.muteTime>0?s.text=`群成员：${a.userID} 被禁言`:s.text=`群成员：${a.userID} 被取消禁言`;break;default:s.text="[群提示消息]"}return s}function De(e){return{text:xe(e.payload)}}function ke(e){const s={message:e,name:"",url:""},a=se.filter((s=>s.icon===e.payload.data));return a.length>0&&(s.name=a[0].list[e.payload.index]),e.payload.data.indexOf("@2x")>0?s.name=e.payload.data:s.name=`${e.payload.data}@2x`,s.url=`https://web.sdk.qcloud.com/im/assets/face-elem/${s.name}.png`,s}function Ue(e){const s={lon:"",lat:"",href:"",url:"",description:"",message:e};return s.lon=e.payload.longitude.toFixed(6),s.lat=e.payload.latitude.toFixed(6),s.href=`https://map.qq.com/?type=marker&isopeninfowin=1&markertype=1&pointx=${s.lon}&pointy=${s.lat}&name=${e.payload.description}`,s.url=`https://apis.map.qq.com/ws/staticmap/v2/?center=${s.lat},${s.lon}&zoom=10&size=300*150&maptype=roadmap&markers=size:large|color:0xFFCCFF|label:k|${s.lat},${s.lon}&key=UBNBZ-PTP3P-TE7DB-LHRTI-Y4YLE-VWBBD`,s.description=e.payload.description,s}function Ee(e){return{progress:"unSend"===(null==e?void 0:e.status)&&e.progress,info:e.payload.imageInfoArray,message:e}}function we(e){var s,a;return{progress:"unSend"===(null==e?void 0:e.status)&&(null==e?void 0:e.progress),url:null==(s=null==e?void 0:e.payload)?void 0:s.videoUrl,snapshotUrl:null==(a=null==e?void 0:e.payload)?void 0:a.snapshotUrl,message:e}}function _e(e){return{progress:"unSend"===(null==e?void 0:e.status)&&e.progress,url:e.payload.url,message:e,second:e.payload.second}}function be(e){let s="";return s=e.payload.fileSize>=1048576?`${(e.payload.fileSize/1048576).toFixed(2)} Mb`:e.payload.fileSize>=1024?`${(e.payload.fileSize/1024).toFixed(2)} Kb`:`${e.payload.fileSize.toFixed(2)}B`,{progress:"unSend"===(null==e?void 0:e.status)&&e.progress,url:e.payload.fileUrl,message:e,name:e.payload.fileName,size:s}}function Le(e){return{message:e,...e.payload}}function Pe(e){let s={},a={};try{s=JSON.parse(e.payload.data)}catch(t){s={}}if(1!==s.businessID)return"";try{a=JSON.parse(s.data)}catch(t){a={}}switch(s.actionType){case 1:return a.call_end>=0&&!s.groupID?`通话时长 ：${X(a.call_end)}`:s.groupID?"结束群聊":a.data&&"switchToAudio"===a.data.cmd?"切换语音通话":a.data&&"switchToVideo"===a.data.cmd?"切换视频通话":"发起通话";case 2:return"取消通话";case 3:return a.data&&"switchToAudio"===a.data.cmd?"切换语音通话":a.data&&"switchToVideo"===a.data.cmd?"切换视频通话":"已接听";case 4:return"拒绝通话";case 5:return a.data&&"switchToAudio"===a.data.cmd?"切换语音通话":a.data&&"switchToVideo"===a.data.cmd?"切换视频通话":"无应答";default:return""}}function Ae(e){var s;return{message:e,custom:Pe(e)||(null==(s=null==e?void 0:e.payload)?void 0:s.extension)||"[自定义消息]"}}function Re(e){var s,a;const t=(null==(s=e.payload.groupProfile)?void 0:s.name)||(null==(a=e.payload.groupProfile)?void 0:a.groupID);switch(e.payload.operationType){case 1:return`${e.payload.operatorID} 申请加入群组：${t}`;case 2:return`成功加入群组：${t}`;case 3:return`申请加入群组：${t} 被拒绝`;case 4:return`你被管理员 ${e.payload.operatorID} 踢出群组：${t}`;case 5:return`群：${t} 被 ${e.payload.operatorID} 解散`;case 6:return`${e.payload.operatorID} 创建群：${t}`;case 7:case 12:return`${e.payload.operatorID} 邀请你加群：${t}`;case 8:return`你退出群组：${t}`;case 9:return`你被${e.payload.operatorID} 设置为群：${t} 的管理员`;case 10:return`你被 ${e.payload.operatorID} 撤销群：${t} 的管理员身份`;case 13:return`${e.payload.operatorID} 同意加群 ：${t}`;case 14:return`${e.payload.operatorID} 拒接加群 ：${t}`;case 255:return`自定义群系统通知: ${e.payload.userDefinedField}`}}const je=Q(e({props:{data:{type:Array,default:()=>[]},types:{type:Object,default:()=>({})}},setup(e,o){const n=s({messageList:[],types:{}});a((()=>{n.messageList=e.data,n.types=e.types}));return{...t(n),translateGroupSystemNotice:Re,handleApplication:()=>{k({itemList:["同意","拒绝"],success:e=>{const s={handleAction:"Agree",handleMessage:"欢迎进群",message:this.message};1===e.tapIndex&&(s.handleAction="Reject",s.handleMessage="拒绝申请"),uni.$TUIKit.handleGroupApplication(s).then((()=>{S({title:"Agree"===s.handleAction?"已同意申请":"已拒绝申请"})})).catch((e=>{S({title:e.message||"处理失败",icon:"none"})}))}})},caculateTimeago:H}}}),[["render",function(e,s,a,t,c,u){const g=f;return o(!0),h(T,null,y(e.messageList,((s,a)=>(o(),n(g,{key:a},{default:i((()=>[1===s.payload.operationType?(o(),n(g,{key:0,class:"card handle"},{default:i((()=>[l(g,null,{default:i((()=>[l(g,{class:"time"},{default:i((()=>[r(d(e.caculateTimeago(1e3*s.time)),1)])),_:2},1024),r(" "+d(e.translateGroupSystemNotice(s)),1)])),_:2},1024),l(g,{class:"choose"},{default:i((()=>[l(g,{class:"button",onClick:e.handleClick},{default:i((()=>[r("处理")])),_:1},8,["onClick"])])),_:1})])),_:2},1024)):(o(),n(g,{key:1,class:"card"},{default:i((()=>[l(g,{class:"time"},{default:i((()=>[r(d(e.caculateTimeago(1e3*s.time)),1)])),_:2},1024),r(" "+d(e.translateGroupSystemNotice(s)),1)])),_:2},1024))])),_:2},1024)))),128)}],["__scopeId","data-v-9d5c1848"]]);const Ne=Q(e({props:{show:{type:Boolean,default:()=>!1},isMute:{type:Boolean,default:()=>!1}},setup(e,o){const n=s({emojiUrl:ee,emojiMap:q,emojiName:ae,faceUrl:te,bigEmojiList:se,show:!1,currentIndex:0,isMute:!1}),i=U();a((()=>{n.show=e.show,n.isMute=e.isMute}));const l=E((()=>{const e=[n.emojiName];for(let s=0;s<n.bigEmojiList.length;s++)e.push(n.bigEmojiList[s].list);return e})),r=e=>{n.currentIndex=e};return{...t(n),toggleShow:()=>{n.isMute||(n.show=!n.show),n.show||r(0)},select:async(e,s)=>{const a={name:e};if(0===n.currentIndex)return a.type="emo",a.url=ee+q[e],a.template=`<image src="${ee+q[e]}"></image>`,o.emit("send",a);try{await uni.$TUIKit.TUIChatServer.sendFaceMessage({index:s,data:e})}catch(t){}},selectFace:r,list:l,dialog:i,handleSendEmoji:()=>o.emit("handleSendEmoji")}}}),[["render",function(e,s,a,t,d,u){const g=f,m=p;return o(),n(g,{class:"face"},{default:i((()=>[l(g,{class:"icon icon-face",onClick:e.toggleShow},null,8,["onClick"]),w(l(g,{class:"face-main",ref:"dialog"},{default:i((()=>[(o(!0),h(T,null,y(e.list,((s,a)=>(o(),n(g,{class:"face-main-box",key:a},{default:i((()=>[e.currentIndex===a?(o(),n(g,{key:0,class:"face-list"},{default:i((()=>[(o(!0),h(T,null,y(s,((s,t)=>(o(),n(g,{class:"face-list-item",key:t,onClick:a=>e.select(s,t)},{default:i((()=>[0===a?(o(),n(m,{key:0,class:"emo-image",src:e.emojiUrl+e.emojiMap[s]},null,8,["src"])):(o(),n(m,{key:1,class:"face-img",src:e.faceUrl+s+"@2x.png"},null,8,["src"]))])),_:2},1032,["onClick"])))),128))])),_:2},1024)):c("",!0)])),_:2},1024)))),128)),l(g,{class:"face-tab"},{default:i((()=>[l(g,{class:"face-tab-item",onClick:s[0]||(s[0]=s=>e.selectFace(0))},{default:i((()=>[l(g,{class:"icon icon-face"})])),_:1}),(o(!0),h(T,null,y(e.bigEmojiList,((s,a)=>(o(),n(g,{class:"face-tab-item",key:a,onClick:s=>e.selectFace(a+1)},{default:i((()=>[l(m,{class:"face-icon",src:e.faceUrl+s.icon+"@2x.png"},null,8,["src"])])),_:2},1032,["onClick"])))),128)),l(g,{class:"send-btn",onClick:e.handleSendEmoji},{default:i((()=>[r("发送")])),_:1},8,["onClick"])])),_:1})])),_:1},512),[[_,e.show]])])),_:1})}],["__scopeId","data-v-6394b0f7"]]),Ge=e({props:{show:{type:Boolean,default:()=>!1}},setup(e,a){const o=s({popupToggle:!1,isRecording:!1,canSend:!0,text:"按住说话",recorderManager:null,title:" ",recordTime:0,recordTimer:null});D((()=>{recorderManager.onStop((e=>{clearInterval(o.recordTimer);let s={duration:e.duration?e.duration:1e3*o.recordTime,tempFilePath:e.tempFilePath,fileSize:e.fileSize?e.fileSize:48*o.recordTime/8*1024};b(),o.canSend&&(s.duration<1e3?S({title:"录音时间太短",icon:"none"}):uni.$TUIKit.TUIChatServer.sendAudioMessage(s)),o.popupToggle=!1,o.isRecording=!1,o.canSend=!0,o.title=" ",o.text="按住说话"}))}));return{...t(o),sendUploadMessage:e=>{Video.TUIServer.sendVideoMessage(e.target)},handleLongPress:e=>{o.popupToggle=!0,recorderManager.start({duration:6e4,sampleRate:44100,numberOfChannels:1,encodeBitRate:192e3,format:"aac"}),o.startPoint=e.target,o.title="正在录音",o.isRecording=!0,o.recordTime=0,o.recordTimer=setInterval((()=>{o.recordTime++}),1e3)},handleTouchEnd:()=>{o.isRecording=!1,o.popupToggle=!1,o.text="按住说话",b(),recorderManager.stop()},handleTouchMove:e=>{o.isRecording&&(e.currentTarget.offsetTop-e.changedTouches[e.changedTouches.length-1].clientY>100?(o.text="抬起停止",o.title="松开手指，取消发送",o.canSend=!1):e.currentTarget.offsetTop-e.changedTouches[e.changedTouches.length-1].clientY>20?(o.text="抬起停止",o.title="上划可取消",o.canSend=!0):(o.text="抬起停止",o.title="正在录音",o.canSend=!0))}}}});const Oe=e({components:{Face:Ne,AudioMessage:Q(Ge,[["render",function(e,s,a,t,u,g){const m=L,h=f;return o(),n(h,{class:"TUI-message-input-main",onLongpress:e.handleLongPress,onTouchmove:e.handleTouchMove,onTouchend:e.handleTouchEnd},{default:i((()=>[l(m,null,{default:i((()=>[r(d(e.text),1)])),_:1}),e.popupToggle?(o(),n(h,{key:0,class:"record-modal",onLongpress:e.handleLongPress,onTouchmove:e.handleTouchMove,onTouchend:e.handleTouchEnd},{default:i((()=>[l(h,{class:"wrapper"},{default:i((()=>[l(h,{class:"modal-loading"})])),_:1}),l(h,{class:"modal-title"},{default:i((()=>[r(d(e.title),1)])),_:1})])),_:1},8,["onLongpress","onTouchmove","onTouchend"])):c("",!0)])),_:1},8,["onLongpress","onTouchmove","onTouchend"])}],["__scopeId","data-v-88300ea5"]])},props:{text:{type:String,default:()=>""},conversationData:{type:Object,default:()=>""}},setup(e){const o=uni.$TUIKit.TUIChatServer,n=s({firstSendMessage:!0,inputText:"",extensionArea:!1,sendMessageBtn:!1,displayFlag:"",isAudio:!1,displayServiceEvaluation:!1,displayCommonWords:!1,displayOrderList:!1,conversation:E((()=>oe.state.timStore.conversation))});a((()=>{n.inputText=e.text}));return{...t(n),handleExtensions:e=>{n.displayFlag="extension"===n.displayFlag?"":"extension"},handleSendImageMessage:e=>{P({sourceType:[e],count:1,success:e=>{A({src:e.tempFilePaths[0],success(s){console.error(s),o.sendImageMessage(e,s)}})}})},handleSendTextMessage:e=>{n.inputText.trimEnd()&&uni.$TUIKit.TUIChatServer.sendTextMessage(JSON.parse(JSON.stringify(n.inputText))),n.inputText=" "},handleSendVideoMessage:e=>{R({sourceType:[e],maxDuration:60,camera:"back",success:e=>{e&&o.sendVideoMessage(e)}})},handleEmoji:()=>{n.displayFlag="emoji"===n.displayFlag?"":"emoji"},handleSend:e=>{n.inputText+=e.name},handleSwitchAudio:()=>{n.isAudio=!n.isAudio},handleCalling:e=>{"GROUP"!==n.conversation.type?(n.conversation.userProfile,S({title:"暂不支持",icon:"none"})):S({title:"群聊暂不支持",icon:"none"})}}}}),Ve="/assets/emoji-6e26cc5c.svg",$e="/assets/take-photo-9e4e95a7.svg";const Fe=Q(e({name:"TUIChat",components:{MessageText:de,MessageImage:ce,MessageVideo:he,MessageAudio:Te,MessageFace:ye,MessageCustom:Me,MessageBubble:re,MessageTip:ve,MessageRevoked:Se,MessageSystem:je,TUIChatInput:Q(Oe,[["render",function(e,s,a,t,d,u){const g=p,m=N,h=f,I=j("AudioMessage"),T=j("Face");return o(),n(h,{class:"TUI-message-input-container"},{default:i((()=>[l(h,{class:"TUI-message-input"},{default:i((()=>[l(g,{class:"TUI-icon",onClick:e.handleEmoji,src:Ve},null,8,["onClick"]),e.isAudio?(o(),n(h,{key:1,class:"TUI-message-input-main"},{default:i((()=>[l(I)])),_:1})):(o(),n(h,{key:0,class:"TUI-message-input-main"},{default:i((()=>[l(m,{class:"TUI-message-input-area","adjust-position":!1,"hold-keyboard":!0,"cursor-spacing":"20",modelValue:e.inputText,"onUpdate:modelValue":s[0]||(s[0]=s=>e.inputText=s),"confirm-type":"send","confirm-hold":"true",onConfirm:e.handleSendTextMessage,maxlength:"140",type:"text","placeholder-class":"input-placeholder",placeholder:"说点什么呢~"},null,8,["modelValue","onConfirm"])])),_:1})),l(h,{class:"TUI-message-input-functions","hover-class":"none"},{default:i((()=>[l(g,{class:"TUI-icon",onClick:e.handleEmoji,src:Ve},null,8,["onClick"]),l(h,{onClick:e.handleExtensions},{default:i((()=>[l(g,{class:"TUI-icon",src:"/assets/more-78d0c1ce.svg"})])),_:1},8,["onClick"])])),_:1})])),_:1}),"emoji"===e.displayFlag?(o(),n(h,{key:0,class:"TUI-Emoji-area"},{default:i((()=>[l(T,{show:"emoji"===e.displayFlag,onSend:e.handleSend,onHandleSendEmoji:e.handleSendTextMessage},null,8,["show","onSend","onHandleSendEmoji"])])),_:1})):c("",!0),"extension"===e.displayFlag?(o(),n(h,{key:1,class:"TUI-Extensions"},{default:i((()=>[l(h,{class:"TUI-Extension-slot",onClick:s[1]||(s[1]=s=>e.handleSendImageMessage("camera"))},{default:i((()=>[l(g,{class:"TUI-Extension-icon",src:$e}),l(h,{class:"TUI-Extension-slot-name"},{default:i((()=>[r("拍照")])),_:1})])),_:1}),l(h,{class:"TUI-Extension-slot",onClick:s[2]||(s[2]=s=>e.handleSendImageMessage("album"))},{default:i((()=>[l(g,{class:"TUI-Extension-icon",src:"/assets/send-img-09e5512c.svg"}),l(h,{class:"TUI-Extension-slot-name"},{default:i((()=>[r("图片")])),_:1})])),_:1}),l(h,{class:"TUI-Extension-slot",onClick:s[3]||(s[3]=s=>e.handleSendVideoMessage("album"))},{default:i((()=>[l(g,{class:"TUI-Extension-icon",src:"/assets/take-video-0436f300.svg"}),l(h,{class:"TUI-Extension-slot-name"},{default:i((()=>[r("视频")])),_:1})])),_:1}),l(h,{class:"TUI-Extension-slot",onClick:s[4]||(s[4]=s=>e.handleSendVideoMessage("camera"))},{default:i((()=>[l(g,{class:"TUI-Extension-icon",src:$e}),l(h,{class:"TUI-Extension-slot-name"},{default:i((()=>[r("录像")])),_:1})])),_:1})])),_:1})):c("",!0)])),_:1})}],["__scopeId","data-v-1f95e26a"]]),MessageOperate:ge},setup(e){const a=oe.state.timStore;uni.$TUIKit.TUIChatServer=new le;const o=G(null),n=uni.$TUIKit.TUIChatServer,i={top:-70,left:0,right:0},l=s({conversationName:"",messageList:E((()=>a.messageList)),conversation:E((()=>a.conversation)),triggered:!1,scrollTop:999,text:"",types:uni.$TIM.TYPES,currentMessage:{},dialogID:"",forwardStatus:!1,imageFlag:!1,isCompleted:!1,oldMessageTime:0,dialogPosition:i}),r=E((()=>{const e=l.conversation;return(null==e?void 0:e.conversationID)?(null==e?void 0:e.type)===uni.$TIM.TYPES.CONV_SYSTEM?"system":"chat":""})),d=E((()=>{if(l.messageList.length>0)return l.oldMessageTime=l.messageList[0].time,l.messageList.filter((e=>!e.isDeleted))}));z((e=>{l.conversationName=e&&e.conversationName})),J((()=>{n.destroyed()})),O(d,((e,s)=>{V((()=>{const a=e[e.length-1],t=s?s[s.length-1]:{};l.oldMessageTime=d.value[0].time,c(),s&&(a.ID,t.ID)}))})),K((()=>{const e={sdkAppID:uni.$chat_SDKAppID,userID:uni.$chat_userID,userSig:uni.$chat_userSig,tim:uni.$TUIKit};uni.$TUICallKit=o,V((()=>{null!==uni.$TUICallKit.value&&uni.$TUICallKit.value.init(e)})),setTimeout((()=>{l.scrollTop=998}),500)})),D((()=>{c(),$("navigateBack",{success(){uni.$TUIKit.TUIConversationServer.setMessageRead(l.conversation.conversationID)}})})),W((()=>{var e;(null==(e=l.conversation)?void 0:e.type)===uni.$TIM.TYPES.CONV_GROUP?x({url:"../TUIGroup/index"}):S({title:"暂无信息"})}));const c=()=>{d.value&&Array.from(d.value).forEach((e=>{e.time-l.oldMessageTime>300?(l.oldMessageTime=e.time,e.showTime=!0):e.showTime=!1}))};return{...t(l),TUICallKit:o,conversationType:r,messages:d,handleShowTime:c,handleTouchStart:()=>{B()},handleRefresher:()=>{l.triggered=!0,l.isCompleted||n.getHistoryMessageList().then((e=>{l.triggered=!1,l.isCompleted=e.isCompleted})),setTimeout((()=>{l.triggered=!1}),500)},handleScroll:e=>{l.triggered="restore"},handleScrollBottom:()=>{Y().select(".TUI-message-list").boundingClientRect((e=>{var s;const a=null==(s=e.height)?void 0:s.height;l.scrollTop=a})).exec()},handleSendTextMessage:e=>{l.text.trimEnd()&&n.sendTextMessage(JSON.parse(JSON.stringify(l.text))),l.text=" "},handleItem:(e,s)=>{const{flow:a}=s;try{Y().select("#"+(s.flow+"-"+s.ID)).boundingClientRect((e=>{var s;const{top:t}=e;t<80?(l.dialogPosition={...l.dialogPosition,top:(null==(s=e.height)?void 0:s.res)+10},l.dialogPosition={...l.dialogPosition,right:"out"===a?0:null,left:"in"===a?0:null}):l.dialogPosition={...i,right:"out"===a?0:null,left:"in"===a?0:null}})).exec((e=>{l.currentMessage=s,l.dialogID=s.ID}))}catch(t){l.currentMessage=s,l.dialogID=s.ID}},handleEdit:e=>{l.text=e.payload.text},handleTextMessageShowContext:De,handleImageMessageShowContext:Ee,handleVideoMessageShowContext:we,handleAudioMessageShowContext:_e,handleFileMessageShowContext:be,handleFaceMessageShowContext:ke,handleLocationMessageShowContext:Ue,handleMergerMessageShowContext:Le,handleTipMessageShowContext:Ce,handleCustomMessageShowContext:Ae,handleSend:e=>{l.text+=e.name},caculateTimeago:H,handleGetProfile:()=>{x({url:"../TUIGroup/index"})},back:()=>{F({url:"/pages/TUIKit/TUIPages/TUIConversation/index"})}}}}),[["render",function(e,s,a,t,u,g){const m=p,I=f,M=j("var-app-bar"),S=j("MessageTip"),x=j("Message-Operate"),C=j("MessageText"),D=j("MessageImage"),k=j("MessageVideo"),U=j("MessageAudio"),E=j("MessageFace"),w=j("MessageCustom"),_=j("MessageBubble"),b=j("MessageRevoked"),L=Z,P=j("TUIChatInput"),A=j("MessageSystem");return o(),h(T,null,[l(M,{style:{border:"none",position:"fixed",top:"0","z-index":"2","background-color":"#fff"},color:"#fff",round:"",elevation:!1},{content:i((()=>[l(I,{class:"nav"},{default:i((()=>{var s;return[l(m,{onClick:e.back,style:{width:"40rpx",height:"40rpx",margin:"0 20rpx",position:"absolute",left:"0"},src:ie,mode:"widthFix"},null,8,["onClick"]),l(I,{class:"navtitle"},{default:i((()=>[r(d(e.conversationName),1)])),_:1}),"GROUP"===(null==(s=e.conversation)?void 0:s.type)?(o(),n(I,{key:0,style:{width:"80rpx",height:"40rpx",position:"absolute",right:"20rpx",color:"#000","font-size":"28rpx"},onClick:e.handleGetProfile},{default:i((()=>[r(" 更多")])),_:1},8,["onClick"])):c("",!0)]})),_:1})])),_:1}),"chat"===e.conversationType?(o(),n(I,{key:0,class:"TUIChat",style:{}},{default:i((()=>[l(I,{style:{width:"100%",height:"180rpx"}}),l(I,{class:"TUIChat-container"},{default:i((()=>[l(L,{class:"TUIChat-main","scroll-y":"true","scroll-with-animation":!0,"refresher-triggered":e.triggered,"refresher-enabled":!0,onRefresherrefresh:e.handleRefresher,"scroll-top":e.scrollTop},{default:i((()=>[l(I,{class:"TUI-message-list",onTouchstart:e.handleTouchStart,onClick:s[0]||(s[0]=s=>e.dialogID="")},{default:i((()=>[e.isCompleted?(o(),n(I,{key:0,class:"loading-text"},{default:i((()=>[r("没有更多")])),_:1})):c("",!0),(o(!0),h(T,null,y(e.messages,((s,a)=>(o(),n(I,{key:s.ID,id:"view"+s.ID},{default:i((()=>[s.showTime?(o(),n(I,{key:0,class:"time-container"},{default:i((()=>[r(d(e.caculateTimeago(1e3*s.time)),1)])),_:2},1024)):c("",!0),s.isRevoked||s.type!==e.types.MSG_GRP_TIP?c("",!0):(o(),n(S,{key:1,data:e.handleTipMessageShowContext(s)},null,8,["data"])),s.isRevoked||s.type===e.types.MSG_GRP_TIP?c("",!0):(o(),n(_,{key:2,data:s},{default:i((()=>[e.dialogID===s.ID?(o(),n(x,{key:0,data:s,class:"dialog dialog-item",style:v({top:e.dialogPosition.top+"px",right:e.dialogPosition.right+"px",left:e.dialogPosition.left+"px"})},null,8,["data","style"])):c("",!0),s.type===e.types.MSG_TEXT?(o(),n(C,{key:1,id:s.flow+"-"+s.ID,data:e.handleTextMessageShowContext(s),messageData:s,onLongpress:a=>e.handleItem(a,s)},null,8,["id","data","messageData","onLongpress"])):c("",!0),s.type===e.types.MSG_IMAGE?(o(),n(D,{key:2,id:s.flow+"-"+s.ID,data:e.handleImageMessageShowContext(s),messageData:s,onLongpress:a=>e.handleItem(a,s)},null,8,["id","data","messageData","onLongpress"])):c("",!0),s.type===e.types.MSG_VIDEO?(o(),n(k,{key:3,id:s.flow+"-"+s.ID,data:e.handleVideoMessageShowContext(s),messageData:s,onLongpress:a=>e.handleItem(a,s)},null,8,["id","data","messageData","onLongpress"])):c("",!0),s.type===e.types.MSG_AUDIO?(o(),n(U,{key:4,id:s.flow+"-"+s.ID,data:e.handleAudioMessageShowContext(s),messageData:s,onLongpress:a=>e.handleItem(a,s)},null,8,["id","data","messageData","onLongpress"])):c("",!0),s.type===e.types.MSG_FACE?(o(),n(E,{key:5,id:s.flow+"-"+s.ID,data:e.handleFaceMessageShowContext(s),messageData:s,onLongpress:a=>e.handleItem(a,s)},null,8,["id","data","messageData","onLongpress"])):c("",!0),s.type===e.types.MSG_CUSTOM?(o(),n(w,{key:6,id:s.flow+"-"+s.ID,data:e.handleCustomMessageShowContext(s),messageData:s,onLongpress:a=>e.handleItem(a,s)},null,8,["id","data","messageData","onLongpress"])):c("",!0)])),_:2},1032,["data"])),s.isRevoked?(o(),n(b,{key:3,data:s,onEdit:a=>e.handleEdit(s)},null,8,["data","onEdit"])):c("",!0)])),_:2},1032,["id"])))),128))])),_:1},8,["onTouchstart"])])),_:1},8,["refresher-triggered","onRefresherrefresh","scroll-top"])])),_:1}),l(P,{text:e.text,conversationData:e.conversation},null,8,["text","conversationData"])])),_:1})):c("",!0),"system"===e.conversationType?(o(),n(I,{key:1,class:"TUIChat"},{default:i((()=>[l(I,{style:{width:"100%",height:"180rpx"}}),l(A,{data:e.messages,types:e.types},null,8,["data","types"])])),_:1})):c("",!0)],64)}],["__scopeId","data-v-8896279c"]]);export{Fe as default};
